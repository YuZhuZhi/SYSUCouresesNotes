# 量子计算(八)——振幅放大

## 一、问题背景

这个算法要解决的问题就是寻找符合要求的解。假设解空间可以被表示为二进制字符串，并且已知某种能够确定解空间中各个解的好坏的标准。

>也就是给出布尔函数$\mathcal{X}$，它将解空间中的解$x$映射到$\{0,1\}$：
>$$\mathcal{X}(x)=\begin{cases}
    0 & ,\quad if\ x\ is\ bad\\
    1 & ,\quad if\ x\ is\ good\\
\end{cases}$$

这个目标基本和$Grover$算法要解决的问题是一致的。事实上，$Grover$算法中的核心算法就是振幅放大，这篇论文就是对$Grover$算法的总结推广，使得任意无测量量子算法也可以使用。

### 1.量子化

显然，由于解空间被表示为二进制串，因而解空间可以作为一个希尔伯特空间，从而允许量子算法的运行。而解的好坏，则将其划分为两个子空间——称为好空间与坏空间。于是解空间的任意纯态$| \psi \rangle$都可以被分解表示为：

$$| \psi \rangle=| \psi_0 \rangle+| \psi_1 \rangle$$

其中$| \psi_0 \rangle$表示落入坏空间的部分，相应地$| \psi_1 \rangle$表示落入好空间的部分。于是$b_\psi=\langle \psi_0 | \psi_0 \rangle$表示了对这个纯态测量后得到坏结果的概率，$a_\psi=\langle \psi_1 | \psi_1 \rangle$则是得到好结果的概率，以后简记为$a$。显然$a_\psi+b_\psi=1$。

到这一步，我们的目标就已经清晰明朗了：只要让好空间部分的$| \psi_1 \rangle$振幅变大，就提高了测到好结果的概率。之后只需要代入$\mathcal{X}$判定其是否确实是好结果即可。

---

## 二、振幅放大的构建

### 1.振幅放大算符$\mathbf{Q}$

假定$n$是解空间的二进制串的长度。假设无测量量子算法$\mathcal{A}$是作用到解空间上的酉矩阵，并假设纯态$| \Psi \rangle=\mathcal{A}| 0^n \rangle$是由其作用到初始零态的结果。那么如下构建的算符即可实现振幅放大：

$$\mathbf{Q}=\mathbf{Q}(\mathcal{A},\mathcal{X})=-\mathcal{A}\mathbf{S}_0\mathcal{A}^{-1}\mathbf{S}_\mathcal{X}$$

其中，$\mathbf{S}$代表它会改变振幅的符号，而下标表示改变的条件：

$$\mathbf{S}_0| x \rangle=\begin{cases}
    -| x \rangle & ,\quad if\ x=0^n\\
    | x \rangle & ,\quad if\ x\neq0^n\\
\end{cases}$$

$$\mathbf{S}_\mathcal{X}| x \rangle=\begin{cases}
    -| x \rangle & ,\quad if\ \mathcal{X}(x)=1\\
    | x \rangle & ,\quad if\ \mathcal{X}(x)=0\\
\end{cases}$$

>显然可以将$\mathbf{S}_0$写为$I-2| 0^n \rangle\langle 0^n |$，于是：
>$$\begin{aligned}
    \mathcal{A}\mathbf{S}_0\mathcal{A}^{-1}&=\mathcal{A}(I-2| 0^n \rangle\langle 0^n |)\mathcal{A}^{-1}\\
    &=I-2\mathcal{A}| 0^n \rangle\langle 0^n |\mathcal{A}^{-1}\\
    &=I-2| \Psi \rangle\langle \Psi |
\end{aligned}$$

现在我们来研究算符$\mathbf{Q}$作用到任意态上会发生什么。由于在这个问题中纯态被分解为好纯态和坏纯态，因此研究此算符分别作用到好坏纯态上的结果。首先是坏纯态$| \Psi_0 \rangle$：

$$\begin{aligned}
    \mathbf{Q}| \Psi_0 \rangle&=-\mathcal{A}\mathbf{S}_0\mathcal{A}^{-1}\mathbf{S}_\mathcal{X}| \Psi_0 \rangle\\
    &=-\mathcal{A}\mathbf{S}_0\mathcal{A}^{-1}| \Psi_0 \rangle\\
    &=-(I-2| \Psi \rangle\langle \Psi |)| \Psi_0 \rangle\\
    &=-| \Psi_0 \rangle+2(1-a)| \Psi \rangle\\
    &=(1-2a)| \Psi_0 \rangle+2(1-a)| \Psi_1 \rangle\\
\end{aligned}$$

同理对于好纯态$| \Psi_1 \rangle$：

$$\begin{aligned}
    \mathbf{Q}| \Psi_1 \rangle&=-\mathcal{A}\mathbf{S}_0\mathcal{A}^{-1}\mathbf{S}_\mathcal{X}| \Psi_1 \rangle\\
    &=(I-2| \Psi \rangle\langle \Psi |)| \Psi_1 \rangle\\
    &=| \Psi_1 \rangle-2a| \Psi \rangle\\
    &=-2a| \Psi_0 \rangle+(1-2a)| \Psi_1 \rangle\\
\end{aligned}$$

### 2.振幅如何被放大

假设对$| \Psi \rangle$施加$k-1$次$\mathbf{Q}$算符后：

$$\mathbf{Q}^{k-1}| \Psi \rangle=S_k| \Psi_0 \rangle+T_k| \Psi_1 \rangle$$

也就是好纯态的振幅变为$T_k$，显然可以得到下列递推式：

$$\begin{cases}
    S_{k+1}=(1-2a)S_k-2aT_k\\
    T_{k+1}=(2-2a)S_k+(1-2a)T_k\\
\end{cases}\quad,\quad\begin{cases}
    S_1=1\\
    T_1=1\\
\end{cases}$$

解得：

>为了解出上式，首先计算$S_k$与$T_k$的线性组合：
>$$xS_{k+1}+yT_{k+1}=[x(1-2a)+y(2-2a)]S_k+[-2ax+y(1-2a)]T_k$$
>上式能成为等比递推式的条件是：
>$$q=\dfrac{x(1-2a)+y(2-2a)}{x}=\dfrac{-2ax+y(1-2a)}{y}$$
>显然可取$x=\sqrt{a-1},y=\sqrt{a}$从而$q=1-2a-2\sqrt{a(a-1)}$。记$u_k=\sqrt{a-1}S_k+\sqrt{a}T_k$，则$u_1=\sqrt{a-1}+\sqrt{a}$，则$u_k=q^{k-1}u_1$。于是：
>$$S_k=\dfrac{q^{k-1}u_1}{\sqrt{a-1}}-\sqrt{\dfrac{a}{a-1}}T_k$$
>代入递推方程组之第二式得：
>$$T_{k+1}=\left( 1-2a+2\sqrt{a(a-1)} \right)T_k-\dfrac{2\sqrt{a-1}u_1}{q}q^k$$
>记$A=1-2a+2\sqrt{a(a-1)},B=\dfrac{2\sqrt{a-1}u_1}{q},C=q=1-2a-2\sqrt{a(a-1)}$。已知递推形式$a_{n+1}=Aa_n+BC^n$在$A\neq C$时具有通项：
>$$a_n=a_1A^{n-1}+BC\dfrac{A^{n-1}-C^{n-1}}{A-C}$$
>代入可得：

$$\begin{aligned}
    T_k&=\dfrac{\sqrt{a}-\sqrt{a-1}}{2\sqrt{a}}\left( 1-2a+2\sqrt{a(a-1)} \right)^{k-1}\\
    &\quad+\dfrac{\sqrt{a}+\sqrt{a-1}}{2\sqrt{a}}\left( 1-2a-2\sqrt{a(a-1)} \right)^{k-1}\\
\end{aligned}$$

或者说，对于$\mathbf{Q}^{k}| \Psi \rangle$，若记$a=sin^2\theta$且不等于$0$或$1$且限定$\theta\in\left(0,\dfrac{\pi}{2}\right]$，那么其好纯态的振幅是：

$$\begin{aligned}
    T_{k+1}&=\dfrac{\sqrt{a}-\sqrt{a-1}}{2\sqrt{a}}\left( 1-2a+2\sqrt{a(a-1)} \right)^{k}\\
    &\quad+\dfrac{\sqrt{a}+\sqrt{a-1}}{2\sqrt{a}}\left( 1-2a-2\sqrt{a(a-1)} \right)^{k}\\
    &=\dfrac{sin\theta-icos\theta}{2\sqrt{a}}(1-2sin^2\theta+i2sin\theta cos\theta)^k\\
    &\quad+\dfrac{sin\theta+icos\theta}{2\sqrt{a}}(1-2sin^2\theta-i2sin\theta cos\theta)^k\\
    &=\dfrac{-e^{i(\frac{\pi}{2}+\theta)}}{2\sqrt{a}}(cos2\theta+isin2\theta)^k+\dfrac{e^{i(\frac{\pi}{2}-\theta)}}{2\sqrt{a}}(cos2\theta-isin2\theta)^k\\
    &=\dfrac{-e^{i(\frac{\pi}{2}+(2k+1)\theta)}}{2\sqrt{a}}+\dfrac{e^{i(\frac{\pi}{2}-(2k+1)\theta)}}{2\sqrt{a}}\\
    &=\dfrac{1}{\sqrt{a}}\cdot sin\left( (2k+1)\theta \right)\\
\end{aligned}$$

因此，作用$\mathbf{Q}$算符$k$次后，测得好纯态的概率就是$sin^2\left( (2k+1)\theta \right)$。

>当然，论文中也有一套相当优美的计算方法，请自行在论文中查看。

### 3.算符$\mathbf{Q}$作用的次数

显然我们希望测得好纯态的概率越大越好，这就要求$sin^2\left( (2k+1)\theta \right)\to 1$，即$(2k+1)\theta\to \dfrac{\pi}{2}$，即$k=\dfrac{\pi}{4\theta}-\dfrac{1}{2}=\left\lfloor \dfrac{\pi}{4\theta} \right\rfloor$。以后记$\tilde{m}=\dfrac{\pi}{4\theta}-\dfrac{1}{2},m=\left\lfloor \dfrac{\pi}{4\theta} \right\rfloor$。

此时重新计算测得好纯态的概率：

$$\begin{aligned}
    sin^2\left( (2m+1)\theta \right)&\approx sin^2\left( \left( \left\lfloor \dfrac{\pi}{2\theta} \right\rfloor+1 \right)\theta \right)\\
    &\approx sin^2\left( \left\lfloor \dfrac{\pi}{2} \right\rfloor+\theta \right)\\
    &\geq sin^2\left(  \dfrac{\pi}{2}+\theta \right)\\
    &=1-sin^2\theta\\
    &=1-a
\end{aligned}$$

>虽然$sin^2\left( (2m+1)\theta \right)\geq1-a$这一结论是正确的，但上式的证明是稍有问题的，即$sin^2\left( 1+\theta \right)\geq sin^2\left(  \dfrac{\pi}{2}+\theta \right)$这一步。但至少在$\theta\in[0.2854,1.8562]$范围内是没问题的。错误的根本原因在于向下取整内的分母不能直接约分。要想完美证明，接下来只需证$\theta\in[0,0.2854]$内成立即可，这里不再证明。论文中的证明是引用另一篇文章，请自行观阅。

也就是说测量到好纯态的概率是大于$1-a$的；同时由于本就是对好纯态振幅的放大，因此这个概率也大于$a$。因此最后测到好纯态的概率至少是$max\{ a,1-a \}$。

然而这引申出一个问题：之所以能要求让$\mathbf{Q}$作用$\left\lfloor \dfrac{\pi}{4\theta} \right\rfloor$次，是因为我们已知了$\theta$值，即已知了$a$值，即已知在最初的时候能够测得好纯态的概率，例如$Grover$算法中就是如此。但在实际问题中，很多时候这个值具有置信度，甚至完全未知，此时则不能确定$\mathbf{Q}$作用的次数。因此，我们有必要从$Grover$搜索算法进一步推广。

---

## 三、$QSearch$算法

在$a$未知的情况下，$Grover$算法不能发挥太大的作用，因为不知道算符$\mathbf{Q}$应当作用的次数，使得测得好纯态的概率偏离最优值。为此，我们推广其至$QSearch$算法。

### 1.算法流程

1. `int l = 1;    float c = random(start=1, end=2);`$c$不等于$1$或$2$。
2. `l++;    int M = (int)pow(c, l) + 1;`
3. 将$\mathcal{A}$作用于初始零态$| 0^n \rangle$，并测量得到$| x \rangle$。如果是好结果，即$\mathcal{X}(x)=1$，那么`return x;`
4. 否则，记录$| \Psi \rangle=\mathcal{A}| 0^n \rangle$。
5. `int j = (int)random(1, M);`
6. 将算符$\mathbf{Q}$作用到$| \Psi \rangle$上$j$次，即$\mathbf{Q}^j| \Psi \rangle$。
7. 测量结果得到$| x \rangle$。如果是好结果，那么`return x;`否则，`goto step2;`


